services:
  krayin:
    build: .
    restart: unless-stopped
    environment:
      APP_NAME: "CRM Catapulta"
      APP_ENV: production
      APP_DEBUG: "false"
      APP_URL: "https://crm.catapultadigital.com.br"
      ASSET_URL: "https://crm.catapultadigital.com.br"
      APP_KEY: "base64:6mSkmvlGK6iV7xHeDhL6+ImXZ7pii0mcHtSNmEAO2x8="
      FORCE_HTTPS: "true"
      TRUSTED_PROXIES: "*"


      SANCTUM_STATEFUL_DOMAINS: "crm.catapultadigital.com.br"
      SESSION_DOMAIN: ".catapultadigital.com.br"
      SESSION_SECURE_COOKIE: "true"
      SESSION_SAME_SITE: "lax"

      APP_CURRENCY: "BRL"
      APP_TIMEZONE: "America/Sao_Paulo"
      APP_LOCALE: "pt_BR"

      LOG_LEVEL: "info"
      LOG_CHANNEL: "stack"

      DB_CONNECTION: "mysql"
      DB_HOST: "mysql"
      DB_PORT: "3306"
      DB_DATABASE: "krayin"
      DB_USERNAME: "krayin"
      DB_PASSWORD: "f5fc464babd5d21735ceec62d6bd2623"

      CACHE_DRIVER: "redis"
      QUEUE_CONNECTION: "redis"
      SESSION_DRIVER: "redis"

      REDIS_HOST: "redis"
      REDIS_PORT: "6379"

      MAIL_MAILER: "smtp"
      MAIL_HOST: ""
      MAIL_PORT: ""
      MAIL_USERNAME: ""
      MAIL_PASSWORD: ""
      MAIL_ENCRYPTION: "tls"
      MAIL_FROM_ADDRESS: "no-reply@localhost"
      MAIL_FROM_NAME: "Krayin CRM"

    volumes:
      - krayin_storage:/var/www/html/storage

    depends_on:
      mysql:
        condition: service_healthy
      redis:
        condition: service_healthy

    healthcheck:
      test: ["CMD-SHELL", "curl -fsS http://localhost/ >/dev/null || exit 1"]
      interval: 15s
      timeout: 5s
      retries: 20

  krayin-worker:
    build: .
    restart: unless-stopped
    environment:
      APP_NAME: "CRM Catapulta"
      APP_ENV: production
      APP_DEBUG: "false"
      APP_URL: "https://crm.catapultadigital.com.br"
      ASSET_URL: "https://crm.catapultadigital.com.br"
      APP_KEY: "base64:6mSkmvlGK6iV7xHeDhL6+ImXZ7pii0mcHtSNmEAO2x8="
      FORCE_HTTPS: "true"
      TRUSTED_PROXIES: "*"

      DB_CONNECTION: "mysql"
      DB_HOST: "mysql"
      DB_PORT: "3306"
      DB_DATABASE: "krayin"
      DB_USERNAME: "krayin"
      DB_PASSWORD: "f5fc464babd5d21735ceec62d6bd2623"

      CACHE_DRIVER: "redis"
      QUEUE_CONNECTION: "redis"
      SESSION_DRIVER: "redis"
      REDIS_HOST: "redis"
      REDIS_PORT: "6379"

    volumes:
      - krayin_storage:/var/www/html/storage

    depends_on:
      mysql:
        condition: service_healthy
      redis:
        condition: service_healthy

    command: ["sh", "-lc", "php artisan queue:work --sleep=3 --tries=3 --timeout=120"]

  krayin-scheduler:
    build: .
    restart: unless-stopped
    environment:
      APP_NAME: "CRM Catapulta"
      APP_ENV: production
      APP_DEBUG: "false"
      APP_URL: "https://crm.catapultadigital.com.br"
      ASSET_URL: "https://crm.catapultadigital.com.br"
      APP_KEY: "base64:6mSkmvlGK6iV7xHeDhL6+ImXZ7pii0mcHtSNmEAO2x8="
      FORCE_HTTPS: "true"
      TRUSTED_PROXIES: "*"

      DB_CONNECTION: "mysql"
      DB_HOST: "mysql"
      DB_PORT: "3306"
      DB_DATABASE: "krayin"
      DB_USERNAME: "krayin"
      DB_PASSWORD: "f5fc464babd5d21735ceec62d6bd2623"

      CACHE_DRIVER: "redis"
      QUEUE_CONNECTION: "redis"
      SESSION_DRIVER: "redis"
      REDIS_HOST: "redis"
      REDIS_PORT: "6379"

    volumes:
      - krayin_storage:/var/www/html/storage

    depends_on:
      mysql:
        condition: service_healthy
      redis:
        condition: service_healthy

    command: ["sh", "-lc", "while true; do php artisan schedule:run --no-interaction; sleep 60; done"]

  mysql:
    image: mysql:8.0
    restart: unless-stopped
    environment:
      MYSQL_DATABASE: "krayin"
      MYSQL_USER: "krayin"
      MYSQL_PASSWORD: "f5fc464babd5d21735ceec62d6bd2623"
      MYSQL_ROOT_PASSWORD: "f5fc464babd5d21735ceec62d6bd2623"
    volumes:
      - mysql_data:/var/lib/mysql
    healthcheck:
      test: ["CMD-SHELL", "mysqladmin ping -h 127.0.0.1 -u$$MYSQL_USER -p$$MYSQL_PASSWORD --silent"]
      interval: 10s
      timeout: 5s
      retries: 30

  redis:
    image: redis:7-alpine
    restart: unless-stopped
    command: ["redis-server", "--appendonly", "yes"]
    volumes:
      - redis_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 3s
      retries: 30

volumes:
  krayin_storage:
  mysql_data:
  redis_data:
