services:
  krayin:
    build: .
    restart: unless-stopped
    environment:
      APP_NAME: ${APP_NAME:-Krayin}
      APP_ENV: ${APP_ENV:-production}
      APP_DEBUG: ${APP_DEBUG:-false}
      APP_URL: ${APP_URL:?}
      ASSET_URL: ${ASSET_URL:-${APP_URL}}
      APP_KEY: ${APP_KEY:?}

      SANCTUM_STATEFUL_DOMAINS: ${SANCTUM_STATEFUL_DOMAINS:-}
      SESSION_DOMAIN: ${SESSION_DOMAIN:-}
      SESSION_SECURE_COOKIE: ${SESSION_SECURE_COOKIE:-true}
      SESSION_SAME_SITE: ${SESSION_SAME_SITE:-lax}

      APP_CURRENCY: ${APP_CURRENCY:-BRL}
      APP_TIMEZONE: ${APP_TIMEZONE:-America/Sao_Paulo}
      APP_LOCALE: ${APP_LOCALE:-pt_BR}

      LOG_LEVEL: ${LOG_LEVEL:-info}
      LOG_CHANNEL: ${LOG_CHANNEL:-stack}

      DB_CONNECTION: ${DB_CONNECTION:-mysql}
      DB_HOST: ${DB_HOST:-mysql}
      DB_PORT: ${DB_PORT:-3306}
      DB_DATABASE: ${DB_DATABASE:?}
      DB_USERNAME: ${DB_USERNAME:?}
      DB_PASSWORD: ${DB_PASSWORD:?}

      CACHE_DRIVER: ${CACHE_DRIVER:-redis}
      QUEUE_CONNECTION: ${QUEUE_CONNECTION:-redis}
      SESSION_DRIVER: ${SESSION_DRIVER:-redis}

      REDIS_HOST: ${REDIS_HOST:-redis}
      REDIS_PORT: ${REDIS_PORT:-6379}

      MAIL_MAILER: ${MAIL_MAILER:-smtp}
      MAIL_HOST: ${MAIL_HOST:-}
      MAIL_PORT: ${MAIL_PORT:-}
      MAIL_USERNAME: ${MAIL_USERNAME:-}
      MAIL_PASSWORD: ${MAIL_PASSWORD:-}
      MAIL_ENCRYPTION: ${MAIL_ENCRYPTION:-tls}
      MAIL_FROM_ADDRESS: ${MAIL_FROM_ADDRESS:-no-reply@localhost}
      MAIL_FROM_NAME: ${MAIL_FROM_NAME:-Krayin CRM}

    volumes:
      - krayin_storage:/var/www/html/storage

    depends_on:
      mysql:
        condition: service_healthy
      redis:
        condition: service_healthy

    healthcheck:
      test: ["CMD-SHELL", "curl -fsS http://localhost/ >/dev/null || exit 1"]
      interval: 15s
      timeout: 5s
      retries: 20

  krayin-worker:
    build: .
    restart: unless-stopped
    environment:
      APP_NAME: ${APP_NAME:-Krayin}
      APP_ENV: ${APP_ENV:-production}
      APP_DEBUG: ${APP_DEBUG:-false}
      APP_URL: ${APP_URL:?}
      ASSET_URL: ${ASSET_URL:-${APP_URL}}
      APP_KEY: ${APP_KEY:?}

      DB_CONNECTION: ${DB_CONNECTION:-mysql}
      DB_HOST: ${DB_HOST:-mysql}
      DB_PORT: ${DB_PORT:-3306}
      DB_DATABASE: ${DB_DATABASE:?}
      DB_USERNAME: ${DB_USERNAME:?}
      DB_PASSWORD: ${DB_PASSWORD:?}

      CACHE_DRIVER: ${CACHE_DRIVER:-redis}
      QUEUE_CONNECTION: ${QUEUE_CONNECTION:-redis}
      SESSION_DRIVER: ${SESSION_DRIVER:-redis}
      REDIS_HOST: ${REDIS_HOST:-redis}
      REDIS_PORT: ${REDIS_PORT:-6379}

    volumes:
      - krayin_storage:/var/www/html/storage

    depends_on:
      mysql:
        condition: service_healthy
      redis:
        condition: service_healthy

    command: ["sh", "-lc", "php artisan queue:work --sleep=3 --tries=3 --timeout=120"]

  krayin-scheduler:
    build: .
    restart: unless-stopped
    environment:
      APP_NAME: ${APP_NAME:-Krayin}
      APP_ENV: ${APP_ENV:-production}
      APP_DEBUG: ${APP_DEBUG:-false}
      APP_URL: ${APP_URL:?}
      ASSET_URL: ${ASSET_URL:-${APP_URL}}
      APP_KEY: ${APP_KEY:?}

      DB_CONNECTION: ${DB_CONNECTION:-mysql}
      DB_HOST: ${DB_HOST:-mysql}
      DB_PORT: ${DB_PORT:-3306}
      DB_DATABASE: ${DB_DATABASE:?}
      DB_USERNAME: ${DB_USERNAME:?}
      DB_PASSWORD: ${DB_PASSWORD:?}

      CACHE_DRIVER: ${CACHE_DRIVER:-redis}
      QUEUE_CONNECTION: ${QUEUE_CONNECTION:-redis}
      SESSION_DRIVER: ${SESSION_DRIVER:-redis}
      REDIS_HOST: ${REDIS_HOST:-redis}
      REDIS_PORT: ${REDIS_PORT:-6379}

    volumes:
      - krayin_storage:/var/www/html/storage

    depends_on:
      mysql:
        condition: service_healthy
      redis:
        condition: service_healthy

    command: ["sh", "-lc", "while true; do php artisan schedule:run --no-interaction; sleep 60; done"]

  mysql:
    image: mysql:8.0
    restart: unless-stopped
    environment:
      MYSQL_DATABASE: ${DB_DATABASE:?}
      MYSQL_USER: ${DB_USERNAME:?}
      MYSQL_PASSWORD: ${DB_PASSWORD:?}
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD:?}
    volumes:
      - mysql_data:/var/lib/mysql
    healthcheck:
      test: ["CMD-SHELL", "mysqladmin ping -h 127.0.0.1 -u$$MYSQL_USER -p$$MYSQL_PASSWORD --silent"]
      interval: 10s
      timeout: 5s
      retries: 30

  redis:
    image: redis:7-alpine
    restart: unless-stopped
    command: ["redis-server", "--appendonly", "yes"]
    volumes:
      - redis_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 3s
      retries: 30

volumes:
  krayin_storage:
  mysql_data:
  redis_data:
